"use strict";angular.module("doodleFrontendApp",["ngCookies","ngSanitize"]).config(["$routeProvider",function(a){a.when("/events",{templateUrl:"views/main.html",controller:"EventsCtrl"}).when("/events/:id",{templateUrl:"views/event.html",controller:"EventCtrl"}).when("/register/:id",{templateUrl:"views/register.html",controller:"RegisterCtrl"}).when("/register",{templateUrl:"views/registerSearch.html",controller:"RegisterSearchCtrl"}).when("/new_event",{templateUrl:"views/new_event.html",controller:"NewEventCtrl"}).when("/helmet",{templateUrl:"views/helmet.html",controller:"HelmetCtrl"}).when("/library",{templateUrl:"views/library.html",controller:"LibraryCtrl"}).otherwise({redirectTo:"/events"})}]);var app=angular.module("doodleFrontendApp");app.config(["$httpProvider",function(a){a.defaults.useXDomain=!0,a.defaults.headers.get={Accept:"application/json"},delete a.defaults.headers.common["X-Requested-With"]}]),app.value("BASE_URL","http://ng-doodle-backend.herokuapp.com"),app.factory("Flash",function(){var a={};return a.show=!1,a}),app.factory("Library",function(){var a={};return a}),app.factory("Events",["$http","BASE_URL",function(a,b){var c={};return c.query=function(){return a.get(b+"/events.json")},c.get=function(c){return a.get(b+"/events/"+c+".json")},c.by_identifier=function(c){return a.get(b+"/register/"+c+".json")},c.save=function(c){return a.post(b+"/events.json",c)},c}]),app.factory("Slots",["$http","BASE_URL",function(a,b){var c={};return c.save=function(c){return a.post(b+"/slots.json",c)},c.delete=function(c){return a.delete(b+"/slots/"+c+".json")},c}]),app.factory("Registrations",["$http","BASE_URL",function(a,b){var c={};return c.delete=function(c){return a.delete(b+"/registrations/"+c+".json")},c.save=function(c){return a.post(b+"/registrations.json",c)},c}]),app.factory("Helmet",["$http","$q","BASE_URL",function(a,b,c){var d={};return d.getBooksByAuthor=function(c,d){var e=b.defer(),f=JSON.parse(window.localStorage.getItem(c+"-"+d));if(null!=f)console.log("was in cache"),e.resolve(f);else{console.log("will fetch from server");var g="";d>1&&(g="&page="+d),a.jsonp("http://data.kirjastot.fi/search/author.json?query="+c+g+"&callback=JSON_CALLBACK").success(function(a){window.localStorage.setItem(c+"-"+d,JSON.stringify(a)),console.log(a),e.resolve(a)}).error(function(){e.reject("error...")})}return e.promise},d.getShelfInfo=function(b){var d=b.library_id.substring(11);return a.get(c+"/bookinfo/"+d)},d}]),app.filter("twodigits",function(){return function(a){return a>9?""+a:"0"+a}}),app.filter("stripTrailingSpace",function(){function a(a,b){return-1!==a.indexOf(b,a.length-b.length)}return function(b){return null!=b&&a(b," / ")?b.substring(0,b.length-3):b}}),app.filter("slashToSpace",function(){function a(a,b,c){for(;-1!=a.indexOf(b);)a=a.replace(b,c);return a}return function(b){return null==b?null:a(b,"\\"," ")}}),app.controller("LibraryCtrl",["$scope","Library",function(a,b){function c(b,c){function d(){var a={origin:h,destination:g,travelMode:google.maps.TravelMode.DRIVING};f.route(a,function(a,b){b==google.maps.DirectionsStatus.OK&&e.setDirections(a)})}var e=new google.maps.DirectionsRenderer,f=new google.maps.DirectionsService,g=new google.maps.LatLng(b,c),h=new google.maps.LatLng(a.location.latitude,a.location.longitude),i={center:g,zoom:13},j=new google.maps.Map(document.getElementById("map-canvas"),i);e.setMap(j),setTimeout(function(){google.maps.event.trigger(j,"resize"),j.setCenter(g)},100),new google.maps.Marker({position:g,map:j,title:a.info.name_fi}),new google.maps.Marker({position:h,map:j,title:"current location"}),d()}a.info=b.details||JSON.parse(window.localStorage.getItem("details")),a.location=b.myLocation||JSON.parse(window.localStorage.getItem("location"));var d=window.localStorage.getItem("nolocation");a.nolocation="undefined"==d?!1:JSON.parse(d),a.mapVisible=!1,a.mapLoaded=!1,a.showMap=function(){a.mapLoaded||(c(a.info.latitude,a.info.longitude),a.mapLoaded=!0),a.mapVisible=!a.mapVisible}}]),app.controller("HelmetCtrl",["$scope","Helmet","Library","$location","$timeout",function(a,b,c,d,e){a.location={latitude:60.17,longitude:24.94};var f=window.sessionStorage.getItem("last");a.author="undefined"==f?"":JSON.parse(f),a.library={},a.flash={},a.no_shelf_info={};var g=!1;e(function(){g||(a.flash.nolocation=!0)},1e3),navigator.geolocation.getCurrentPosition(function(b){a.location={latitude:b.coords.latitude,longitude:b.coords.longitude},g=!0,a.$apply()}),a.select=function(b,e){a.library.selected=b,a.library.details=e.library,c.selected=b,c.details=e.library,c.myLocation=a.location,window.localStorage.setItem("selected",JSON.stringify(b)),window.localStorage.setItem("details",JSON.stringify(e.library)),window.localStorage.setItem("location",JSON.stringify(a.location)),window.sessionStorage.setItem("last",JSON.stringify(a.author)),window.localStorage.setItem("nolocation",JSON.stringify(a.flash.nolocation)),d.path("/library")},a.dist=function(a,b,c,d){function e(a){return a*(Math.PI/180)}var f=6371,g=e(c-a),h=e(d-b),i=Math.sin(g/2)*Math.sin(g/2)+Math.cos(e(a))*Math.cos(e(c))*Math.sin(h/2)*Math.sin(h/2),j=2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i)),k=f*j;return k.toFixed(2)};var h=function(a){var b=0==a.author_details.length||null==a.author_details[0].name?[]:a.author_details[0].name.split("\\"),c=0==a.author_details.length||null==a.author_details[0].role?[]:a.author_details[0].role.split("\\");return _.zip(b,c)};a.isEmptyOrUndefinded=function(a){return void 0===a?!0:0===Object.keys(a).length},a.shelfInfo=function(c){return a.flash[c.library_id]=!0,"b1856375"===c.library_id.substring(11)?(console.log(window.localStorage.getItem("kirja")),c.shelfInfo=JSON.parse(window.localStorage.getItem("kirja")),a.flash[c.library_id]=!1,void 0):(b.getShelfInfo(c).success(function(b){c.shelfInfo=b,a.flash[c.library_id]=!1,0===Object.keys(b).length&&(a.no_shelf_info[c.library_id]=!0)}),void 0)},a.searchAuthorPage=function(c){a.flash.nobooks=!1,b.getBooksByAuthor(a.author,c).then(function(b){var d=b.records;console.log(b),console.log(d),0==d.length&&(a.flash.nobooks=!0,a.unsuccess=a.author),_(d).each(function(a){a.all_authors=h(a)}),a.books=d,a.page=c,a.total_entries=b.total_entries;var e=Math.ceil(b.total_entries/12);a.pages=[];for(var f=1;e>=f;f++)a.pages.push(f);a.current=c})}}]),app.controller("EventsCtrl",["$scope","Events",function(a,b){a.visible=!1,a.wait=!0,b.query().success(function(b){a.events=b,a.wait=!1})}]),app.controller("RegisterSearchCtrl",["$scope","$location",function(a,b){a.click=function(){b.path("/register/"+a.eid)}}]),app.controller("RegisterCtrl",["$scope","$routeParams","Events","Registrations",function(a,b,c,d){var e=function(b){for(var c in a.event.slots){var d=a.event.slots[c];if(d.id==b.id)return c}},f=function(b,c){a.event.slots[e(b)].registrations.push({name:c})},g=function(b,c){a.event.slots[e(b)].registrations.splice(c,1)};a.hasMarked=function(a,b){var c=[];return angular.forEach(a.registrations,function(a){c.push(a.name)}),-1!=c.indexOf(b)},a.buttonFor=function(b,c){return a.hasMarked(b,c)?"cancel":"register"},c.by_identifier(b.id).success(function(b){a.event=b,a.names=[],a.slots=a.event.slots,angular.forEach(b.slots,function(b){angular.forEach(b.registrations,function(b){-1==a.names.indexOf(b.name)&&a.names.push(b.name)})})}),a.register=function(b){var c=function(a,b){for(var c in a.registrations){var d=a.registrations[c];if(d.name==b)return{index:c,id:d.id}}};if(a.hasMarked(b,a.name)){var e=c(b,a.name);d.delete(e.id).success(function(){g(b,e.index)}).error(function(){console.log("unauthorized")})}else{var h={slot_id:b.id,name:a.name};d.save(h).success(function(){f(b,a.name)}).error(function(){console.log("unauthorized")})}}}]),app.controller("EventCtrl",["$scope","$routeParams","$location","$anchorScroll","Flash","Events","Slots",function(a,b,c,d,e,f,g){var h=function(a){var b=[];return a.forEach(function(a){-1==b.indexOf(a.date)&&b.push(a.date)}),b.sort()},i=function(){a.newSlot={},a.newSlot.mm=0,a.newSlot.hh=12},j=function(a,b){for(var c in b){var d=b[c];if(d.hh==a.hh&&d.mm==a.mm&&d.date==a.date)return c}};a.flashClicked=function(){a.flash=!1,e.show=!1},a.deleteSlot=function(b){g.delete(b.id).success(function(){var c=j(b,a.event.slots);a.event.slots.splice(c,1)}).error(function(){console.log("unauthorized")})},a.newSlotForm=function(){a.newSlotFormVisible=!0},a.createSlot=function(){var c={event_id:b.id,text:a.newSlot.text,hh:a.newSlot.hh,mm:a.newSlot.mm,date:a.newSlot.date};i(),g.save(c).success(function(b){a.event.slots.push(b),a.dates=h(a.event.slots),a.dateSlotFormVisible=!1,a.newSlotFormVisible=!1}).error(function(){console.log("unauthorized")})},a.newSlotFor=function(b){a.newSlot.date=b,a.visible=!0},a.scrollDown=e.goingDown,console.log("going down: "+a.scrollDown),a.flashSlot=e.flashSlot,i(),f.get(b.id).success(function(b){a.event=b,a.dates=h(a.event.slots),a.flash=e.show})}]),app.controller("NewEventCtrl",["$scope","$location","Flash","Events",function(a,b,c,d){a.flashaa=function(){c.show=!0},a.create=function(){var e={name:a.newEvent.name,description:a.newEvent.description};a.newEvent={},d.save(e).success(function(a){console.log(a),c.show=!0,b.path("/events/"+a.id)}).error(function(){console.log("unauthorized")})}}]);